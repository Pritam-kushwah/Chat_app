<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pritam Kushwah Chat App</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
</head>
<body>

  <!-- Audio Notifications -->
  <audio id="recieveSound" src="/Recieved.mp3" preload="auto"></audio>
  <audio id="sendSound" src="/Send.mp3" preload="auto"></audio>

  <div class="container my-4">
    <h1 class="text-center mb-4">Pritam's Chat Application</h1>

    <!-- Room Controls -->
    <div class="row g-2 mb-3">
      <div class="col-12 col-md-6">
        <input id="roomInput" type="text" class="form-control" placeholder="Enter room name...">
      </div>
      <div class="col-12 col-md-auto d-flex gap-2">
        <button id="joinRoom" class="btn btn-success w-100">Join Room</button>
        <button id="leaveRoom" class="btn btn-danger w-100">Leave Room</button>
      </div>
    </div>

    <!-- Sender Name -->
    <div class="row g-2 mb-3">
      <div class="col-12">
        <input id="senderInput" type="text" class="form-control" placeholder="Your name...">
      </div>
    </div>

    <!-- Chat, Message Box, and Active Users (Reordered) -->
    <div class="row g-3 mb-3">
      <!-- Chat Messages -->
      <div class="col-12 order-1 order-md-1 col-md-9">
        <div id="chat" class="border rounded p-3 bg-light" style="height: 300px; overflow-y: auto;">
          <!-- Messages appear here -->
        </div>
      </div>

      <!-- Message Input and Send Button -->
      <div class="col-12 order-2 order-md-3 d-flex gap-2">
        <input id="messageInput" type="text" class="form-control" placeholder="Type a message...">
        <button id="sendMessage" class="btn btn-primary">Send</button>
      </div>

      <!-- Active Users -->
      <div class="col-12 order-3 order-md-2 col-md-3">
        <div class="border rounded p-2 bg-white" style="height: 300px; overflow-y: auto;">
          <strong>Active Users:</strong>
          <ul id="activeUsers" class="list-unstyled mb-0 mt-2"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript Logic -->
  <script>
    window.onload = function () {
      const userColors = {};
      const colors = ['#0d6efd', '#198754', '#dc3545', '#fd7e14', '#6f42c1', '#20c997'];

      let stompClient = null;
      let currentRoom = null;

      function setConnected(connected) {
        document.getElementById('sendMessage').disabled = !connected;
      }

      function showSystemMessage(text) {
        const chat = document.getElementById('chat');
        const msg = document.createElement('div');
        msg.innerHTML = `<em>${text}</em>`;
        msg.className = "text-muted fst-italic mb-2";
        chat.appendChild(msg);
        chat.scrollTop = chat.scrollHeight;
      }

      function connectToRoom(room) {
        if (stompClient) stompClient.deactivate();

        stompClient = StompJs.Stomp.over(() => new SockJS('/chat'));

        stompClient.connect({}, function (frame) {
          console.log('‚úÖ Connected: ' + frame);
          currentRoom = room;

          stompClient.subscribe(`/topic/${room}`, function (message) {
            showMessage(JSON.parse(message.body));
          });

          stompClient.subscribe(`/topic/${room}/users`, function (message) {
            renderActiveUsers(JSON.parse(message.body));
          });

          setConnected(true);
          document.getElementById('chat').innerHTML = '';
          showSystemMessage(`‚úÖ Joined room: ${room}`);

          const sender = document.getElementById('senderInput').value.trim();
          if (sender) {
            setTimeout(() => {
              const joinMsg = {
                sender,
                content: `üëã ${sender} has joined the room.`,
                room: currentRoom
              };
              stompClient.send("/app/sendMessage", {}, JSON.stringify(joinMsg));
            }, 300);
          }
        }, function (error) {
          console.error('‚ùå Connection error:', error);
          alert('WebSocket connection failed.');
        });
      }

      function sendMessage() {
        const sender = document.getElementById('senderInput').value.trim();
        const content = document.getElementById('messageInput').value.trim();
        const room = currentRoom;

        if (!sender || !content || !room) return;

        const chatMessage = { sender, content, room };
        stompClient.send("/app/sendMessage", {}, JSON.stringify(chatMessage));
        document.getElementById('messageInput').value = '';
      }

      function showMessage(message) {
        const chat = document.getElementById('chat');
        const msg = document.createElement('div');

        if (!userColors[message.sender]) {
          const index = Object.keys(userColors).length % colors.length;
          userColors[message.sender] = colors[index];
        }

        const userColor = userColors[message.sender];
        const time = message.timestamp ? new Date(message.timestamp) : null;
        const timeStr = time ? time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';

        msg.innerHTML = timeStr
          ? `<strong style="color:${userColor}">[${timeStr}] ${message.sender}</strong>: ${message.content}`
          : `<strong style="color:${userColor}">${message.sender}</strong>: ${message.content}`;

        msg.className = "border-bottom mb-1 p-1";
        chat.appendChild(msg);
        chat.scrollTop = chat.scrollHeight;

        const currentUser = document.getElementById('senderInput').value.trim();
        const sound = message.sender !== currentUser ? document.getElementById("recieveSound") : document.getElementById("sendSound");
        if (sound) sound.play();
      }

      function leaveRoom() {
        if (stompClient && currentRoom) {
          const sender = document.getElementById('senderInput').value.trim();

          if (sender) {
            stompClient.send("/app/leaveRoom", {}, JSON.stringify({
              sender,
              content: "",
              room: currentRoom
            }));
          }

          stompClient.deactivate().then(() => {
            showSystemMessage(`üö™ Left room: ${currentRoom}`);
            document.getElementById('chat').innerHTML = '';
            document.getElementById('activeUsers').innerHTML = '';
            setConnected(false);
            currentRoom = null;
          });
        }
      }

      function renderActiveUsers(users) {
        const list = document.getElementById('activeUsers');
        list.innerHTML = '';
        users.forEach(user => {
          const li = document.createElement('li');
          li.textContent = user;
          list.appendChild(li);
        });
      }

      document.getElementById('joinRoom').onclick = () => {
        const room = document.getElementById('roomInput').value.trim();
        if (room) connectToRoom(room);
      };

      document.getElementById('leaveRoom').onclick = leaveRoom;
      document.getElementById('sendMessage').onclick = sendMessage;

      setConnected(false);
    };
  </script>
</body>
</html>
